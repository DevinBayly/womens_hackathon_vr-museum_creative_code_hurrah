<html>

<head>
    <!-- this imports the aframe package that we use for web vr -->
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.9.2/lib/p5.js"></script>
</head>

<body>
    <script>
        AFRAME.registerComponent("anchor-reader", {
            schema: {
                // accept our input as the name of the empty from the blender file that we used to more intuitively position the info and movement icons
                anchorName: { type: "string" },
            },
            init: function () {
                // this is the function that we will use to update the location of the child
                var match_name = function () {
                    var mesh = this.el.getObject3D("mesh") // might need to specify the name actually
                    console.log("this mesh is the one we loaded", mesh)
                    // can search the children for a name matching anchorName
                    // then get the circle within the entity and set the rotation and translation on that
                    let infoCircle = this.el.children[0]
                    for (let anchor of mesh.children) {
                        if (anchor.name == this.data.anchorName) {
                            // unfortunate change of how values are handled between blender's zup and threejs y up
                            // because we switched systems we have to invert the x, and then change which is z vs y, and then make the rotation use y instead of z, the same kinds of inversions are probably used if needing to handle other kinds of rotation, but for eye level info buttons this should be enough
                            infoCircle.object3D.position.copy(anchor.position)
                            infoCircle.object3D.rotation.copy(anchor.rotation)

                        }
                    }

                }
                match_name = match_name.bind(this)
                // here we iterate over the model if it's finished loading and then introduce
                this.el.addEventListener("model-loaded", match_name)
            },
        });
        AFRAME.registerComponent('draw-canvas', {
            schema: { default: '' },

            init: function () {
                let updater = () => {

                    this.canvas = document.getElementById("defaultCanvas0");
                    if (this.canvas) {
                        console.log("yes found canvas", canvas)
                    }
                }
                updater.bind(this)
                setTimeout(updater, 5000)
            },
            tick: function () {

                //     // thanks to https://github.com/aframevr/aframe/issues/3936 for the update fix
                let material = this.el.getObject3D('mesh').material;
                if (!material.map)
                    return;
                else
                    material.map.needsUpdate = true;
            }
        });
    </script>
    <script>
        fetch("https://openprocessing.org/api/curation/87642/sketches?limit=10&offset=0").then(res => res.json()).then(j => {
            console.log(j)
            let thumbURLHash = j[0].thumbnailUpdatedOn.replace(/\D/g, "")
            console.log(thumbURLHash)
            let vid = j[0].visualID
            let thumbURL = `https://openprocessing-usercontent.s3.amazonaws.com/thumbnails/visualThumbnail${vid}@2x.jpg?hash=${thumbURLHash}`

            let holder = document.querySelector("#holder")
            console.log(holder)
            holder.setAttribute("material", `shader:flat;src:${thumbURL}`)
            for (let sketch of j) {
                // get the sketch id
                let id = sketch.visualID
                // fetch code
                fetch(`https://openprocessing.org/api/sketch/${id}/code`).then(res => res.json()).then(j => {
                    console.log(id, j)
                })
            }

        })
    </script>
    <a-scene loading-screen="dotsColor: black; backgroundColor: white" cursor="rayOrigin: mouse">
        <a-assets>
            <canvas id="my-canvas" crossorigin="anonymous" width="512" height="512"></canvas>
            <a-asset-item id="museum" src="museum.glb"></a-asset-item>
            <a-asset-item id="anchors" src="anchors.glb"></a-asset-item>
        </a-assets>
        <a-entity gltf-model="#museum" material="side:double;shader:flat"></a-entity>
        <a-entity anchor-reader="anchorName:piece1" gltf-model="#anchors">
            <!-- </a-entity id="holder" geometry="primitive:plane" width="5" height="6"></a-entity> -->
            <a-entity id="holder" width="6" height="5" geometry="primitive: plane"
                ></a-entity>
        </a-entity>
    </a-scene>

</body>

</html>